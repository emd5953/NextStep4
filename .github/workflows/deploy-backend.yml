name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: ./server
        run: npm ci

      - name: Start ChromaDB
        run: |
          docker run -d --name chromadb -p 8000:8000 chromadb/chroma
          echo "Waiting for ChromaDB to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/api/v1/heartbeat > /dev/null 2>&1; then
              echo "ChromaDB is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          curl http://localhost:8000/api/v1/heartbeat

      - name: Run tests
        working-directory: ./server
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          JWT_SECRET: test_secret_key
          RAG_CHROMA_HOST: localhost
          RAG_CHROMA_PORT: 8000
        run: npm test

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
          
          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'EOF'
            set -e
            cd ~/NextStep4 || cd ~/nextstep
            
            echo "Pulling latest changes..."
            git pull origin main
            
            echo "Installing dependencies..."
            cd server
            npm install
            
            echo "Restarting ChromaDB if needed..."
            docker restart chromadb || docker start chromadb || echo "ChromaDB already running"
            
            echo "Checking if docs changed..."
            if git diff HEAD@{1} HEAD --name-only 2>/dev/null | grep -q "server/docs/" || [ ! -d "data/chroma" ]; then
              echo "Docs changed or first deployment - re-ingesting..."
              npm run ingest:docs
            else
              echo "No doc changes detected"
            fi
            
            echo "Restarting server with PM2..."
            pm2 restart nextstep-server || pm2 start server.js --name nextstep-server
            
            echo "Deployment complete!"
          EOF

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USER@$EC2_HOST << 'EOF'
            echo "Checking PM2 status..."
            pm2 status
            
            echo "Checking ChromaDB..."
            docker ps | grep chromadb
            
            echo "Testing health endpoint..."
            sleep 3
            curl -f http://localhost:4000/api/health || echo "Health check failed"
          EOF

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Check the logs above."
